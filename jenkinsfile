pipeline {
    agent any

    stages {
        stage('Run docker nginx') {
            steps {
                sh 'docker-compose up -d'
            }
        }

        stage('Check HTTP Request'){
            steps {
                script {
                    final String url = 'http://localhost:9889'
                        final def (String response, String code) =
                            sh(script: "curl -s -w '\\n%{response_code}' $url", returnStdout: true)
                                .trim()
                                .tokenize("\n")

                        echo "HTTP response status code: $code"

                        if (code == '200') {
                            echo code
                        }

                }

            }
        }
        
        stage('Check MD5') {
            steps {
                script {
                    String online_md5=sh 'curl -sL http://localhost:9889 | md5sum | cut -d ' ' -f 1'
                    String local_md5=sh 'md5sum "./www/index.html" | cut -d ' ' -f 1'

                    if (online_md5 == local_md5) {
                        echo "It's ok!"
                    }
                }
            }
        }


        stage('Stop and del nginx container'){
            steps {
                sh 'docker stop new_project11_nginx_1'
                sh 'docker rm new_project11_nginx_1'
            }
        }
    }
}